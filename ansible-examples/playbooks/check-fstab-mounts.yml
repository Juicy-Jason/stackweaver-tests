---
# Check mount options in /etc/fstab.
# Reads fstab, parses entries, and reports device, mount point, fstype, and options for each line.
# Run: ansible-playbook -i ../inventory/hosts.ini check-fstab-mounts.yml

- name: Check /etc/fstab mount options
  hosts: all
  gather_facts: true

  tasks:
    - name: Read /etc/fstab
      ansible.builtin.slurp:
        src: /etc/fstab
      register: fstab_raw

    - name: Build fstab report lines
      ansible.builtin.set_fact:
        fstab_report: "{{ fstab_report | default([]) + [report_line] }}"
      loop: "{{ (fstab_raw.content | b64decode).strip().split('\n') }}"
      vars:
        _raw_line: "{{ (item | trim) | regex_replace('\\s+', ' ') }}"
        _parts: "{{ _raw_line | split(' ') }}"
        report_line: "{{ _parts[0] }}  â†’  {{ _parts[1] }}  ({{ _parts[2] }})  options: {{ _parts[3] | default('(none)') }}"
      when:
        - _raw_line | length > 0
        - not (_raw_line is match('^#'))
        - _parts | length >= 4

    - name: Report fstab mount options
      ansible.builtin.debug:
        msg: "{{ fstab_report | default(['No mount entries']) | join('\n') }}"

    - name: No valid fstab entries found
      ansible.builtin.debug:
        msg: "No non-comment mount entries in /etc/fstab"
      when: (fstab_report | default([])) | length == 0
